suite: webhook configuration
templates:
  - templates/instrumentation-crd.yaml
release:
  name: my-release
  namespace: my-namespace
tests:
  - it: uses default failurePolicy Fail for Instrumentation webhooks
    set:
      licenseKey: us-whatever
    asserts:
      - equal:
          path: webhooks[0].failurePolicy
          value: Fail
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - equal:
          path: webhooks[1].failurePolicy
          value: Fail
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - equal:
          path: webhooks[2].failurePolicy
          value: Fail
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration

  - it: uses default podFailurePolicy Ignore for Pod mutation webhook
    set:
      licenseKey: us-whatever
    asserts:
      - equal:
          path: webhooks[3].failurePolicy
          value: Ignore
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration

  - it: does not set timeoutSeconds by default
    set:
      licenseKey: us-whatever
    asserts:
      - notExists:
          path: webhooks[0].timeoutSeconds
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - notExists:
          path: webhooks[1].timeoutSeconds
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - notExists:
          path: webhooks[2].timeoutSeconds
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - notExists:
          path: webhooks[3].timeoutSeconds
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration

  - it: applies custom failurePolicy to Instrumentation webhooks
    set:
      licenseKey: us-whatever
      admissionWebhooks:
        failurePolicy: Ignore
    asserts:
      - equal:
          path: webhooks[0].failurePolicy
          value: Ignore
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - equal:
          path: webhooks[1].failurePolicy
          value: Ignore
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - equal:
          path: webhooks[2].failurePolicy
          value: Ignore
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration

  - it: applies custom podFailurePolicy to Pod mutation webhook
    set:
      licenseKey: us-whatever
      admissionWebhooks:
        podFailurePolicy: Fail
    asserts:
      - equal:
          path: webhooks[3].failurePolicy
          value: Fail
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration

  - it: applies timeoutSeconds to all webhooks when set
    set:
      licenseKey: us-whatever
      admissionWebhooks:
        timeoutSeconds: 15
    asserts:
      - equal:
          path: webhooks[0].timeoutSeconds
          value: 15
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - equal:
          path: webhooks[1].timeoutSeconds
          value: 15
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - equal:
          path: webhooks[2].timeoutSeconds
          value: 15
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - equal:
          path: webhooks[3].timeoutSeconds
          value: 15
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration

  - it: supports combined configuration of all webhook settings
    set:
      licenseKey: us-whatever
      admissionWebhooks:
        failurePolicy: Ignore
        podFailurePolicy: Fail
        timeoutSeconds: 20
    asserts:
      # Instrumentation webhooks use failurePolicy
      - equal:
          path: webhooks[0].failurePolicy
          value: Ignore
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - equal:
          path: webhooks[1].failurePolicy
          value: Ignore
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - equal:
          path: webhooks[2].failurePolicy
          value: Ignore
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      # Pod webhook uses podFailurePolicy
      - equal:
          path: webhooks[3].failurePolicy
          value: Fail
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      # All webhooks use timeoutSeconds
      - equal:
          path: webhooks[0].timeoutSeconds
          value: 20
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - equal:
          path: webhooks[1].timeoutSeconds
          value: 20
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - equal:
          path: webhooks[2].timeoutSeconds
          value: 20
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - equal:
          path: webhooks[3].timeoutSeconds
          value: 20
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration

  - it: validates webhook names are correct
    set:
      licenseKey: us-whatever
    asserts:
      - equal:
          path: webhooks[0].name
          value: minstrumentation-v1beta2.kb.io
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - equal:
          path: webhooks[1].name
          value: minstrumentation-v1beta1.kb.io
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - equal:
          path: webhooks[2].name
          value: minstrumentation-v1alpha2.kb.io
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - equal:
          path: webhooks[3].name
          value: mpod.kb.io
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration

  - it: validates webhook paths are correct
    set:
      licenseKey: us-whatever
    asserts:
      - equal:
          path: webhooks[0].clientConfig.service.path
          value: /mutate-newrelic-com-v1beta2-instrumentation
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - equal:
          path: webhooks[1].clientConfig.service.path
          value: /mutate-newrelic-com-v1beta1-instrumentation
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - equal:
          path: webhooks[2].clientConfig.service.path
          value: /mutate-newrelic-com-v1alpha2-instrumentation
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
      - equal:
          path: webhooks[3].clientConfig.service.path
          value: /mutate-v1-pod
        documentSelector:
          path: kind
          value: MutatingWebhookConfiguration
